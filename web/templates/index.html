<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Post Übersicht</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .iframe-wrapper {
      width: 100%;
      height: 300px;
      border: none;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .card-controls {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      background: #fafafa;
      border-top: 1px solid #ddd;
    }
    .btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .btn-preview {
      background: #0073b1;
      color: white;
    }
    .btn-post {
      background: #fcad04;
      color: rgb(0, 0, 0);
    }
    .btn-schedule {
      background: #dcceff;
      color: rgb(0, 0, 0);
    }
    .btn-confirmed {
      background: #f4f4f4;
      color: black;
    }
    .btn-confirmed.active {
      background: #28a745;
      color: white;
    }
    .btn-origin {
      background: #8bdaff;
      color: black;
    }
    .btn-origin.active {
      background: #0635ef;
      color: white;
    }
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    .posting-list {
        padding: 10px;
        font-size: 13px;
        color: #555;
        float: right;
    }
    .posting-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .posting-list li {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
    }
    .posting-list img {
        width: 16px;
        height: 16px;
    }
    .schedule-list {
      float: left;
        padding: 10px;
        font-size: 13px;
        color: #555;
    }
    .schedule-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .schedule-list li {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
    }
    .schedule-list img {
        width: 16px;
        height: 16px;
    }

    .modal {
      display: none; /* versteckt */
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
  }
  .modal-content {
      background: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 60%;
      max-width: 700px;
  }
  .close {
      float: right;
      font-size: 28px;
      cursor: pointer;
  }

  .modal_g {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
  }
  .modal_g.hidden_g { display: none; }
  .modal_g-content {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    min-width: 250px;
  }

.prompt_show {
    padding-left: 2em;
    padding-right: 2em;
    height: 400px;
    overflow-y: scroll;
    overflow-x: hidden;
    margin-bottom: 1em;
}

.icon{
  height: 40px;
}
  
  </style>
</head>
<body>
  <div class="menu">
    <div class="settings">
      <img src="/content/static/icons/settings.png" class="icon" onclick="window.open('/config', 'settings')">
    </div>
  </div>
  <h1 style="text-align:center;">Prepared Postings</h1>
  <div class="grid">
    {% for template in templates %}
    <div class="card">
      <div class="iframe-wrapper">
          <iframe src="/content/new/{{ template.filename }}"></iframe>
      </div>
      <div class="card-controls">
        <button class="btn btn-new-custom"
                onclick="window.open('/contenteditor?file={{ template.filename }}', '_blank')">
          Create Custom Posting
        </button>
        
      </div>
    </div>
    {% endfor %}
    {% for post in posts %}
      <div class="card">
        <div class="iframe-wrapper">
          <iframe src="/content/new/{{ post.filename }}"></iframe>
        </div>



        <div class="card-controls">
          <button class="btn btn-preview"
                  onclick="window.open('/content/new/{{ post.filename }}', '_blank')">
            Open Preview
          </button>
          <button class="btn btn-edit"
                onclick="window.open('/contenteditor?file={{ post.filename }}', '_blank')">
            Edit
          </button>
          <button class="btn btn-delete"
                  data-filename="{{ post.filename }}"
                  onclick="archivePost(this)">
            Archive
          </button>
        </div>

        <div class="card-controls">
          <button class="btn btn-confirmed {% if post.confirmed == 'Yes' %}active{% endif %}"
                  data-filename="{{ post.filename }}"
                  onclick="toggleConfirmed(this)">
            {% if post.confirmed == "Yes" %}Confirmed{% else %}☐ Confirm{% endif %}
          </button>
          <button class="btn btn-origin {% if post.origin == 'Company' %}active{% endif %}"
                  data-filename="{{ post.filename }}"
                  onclick="changeOrigin(this)">
                  {% if post.origin == "Company" %}Company{% else %}Personal{% endif %}
          </button>
        </div>

        <div class="card-controls">
          <button class="btn btn-post"
                  data-filename="{{ post.filename }}"
                  onclick="postNow(this)">
            Post Now
          </button>
          <button class="btn btn-schedule"
                  data-filename="{{ post.filename }}"
                  >
            Schedule
          </button>
        </div>


        
        <div class="posting-list">
          <ul>
            <li><h4>History</h4></li>
            {% for hentry in post.history %}
              <li>
                <img src="/content/static/icons/{{ hentry.platform }}.png" alt="{{ hentry.platform }}">
                {{ hentry.timestamp }}
              </li>
            {% endfor %}
          </ul>
        </div>
        <div class="schedule-list">
          <ul>
            <li><h4>Schedule</h4></li>
            {% for sentry in post.schedule %}
            <li>
              ⏰ {{ sentry.datetime_fmt }}
            </li>
          {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  </div>



  <h1 style="text-align:center;">Generate new Postings with AI</h1>
  <div class="grid">
      <div class="card">
        <div class="prompt_show">
          <p>Create a new Prompt here</p>
        </div>
        <div class="card-controls">

          <button class="btn btn-promptEdit" data-prompt="{{prompt}}">
            ✏️ Create
          </button>
        </div>
      </div>
    {% for prompt in prompts %}
      <div class="card">
        <div class="prompt_show">
          <p>{{prompt}}</p>
        </div>
        <div class="card-controls">
          <button class="btn generateBtn" data-prompt="{{ prompt }}">
            Generate New
          </button>
          <button class="btn btn-promptEdit" data-prompt="{{prompt}}">
            ✏️ Edit
          </button>
        </div>
      </div>
      {% endfor %}
    </div>



  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <span class="close s_close">&times;</span>
      <iframe id="scheduleFrame" src="" style="width:90%;height:400px;border:none;"></iframe>
    </div>
  </div>


  <div id="promptModal" class="modal">
    <div class="modal-content">
      <span class="close p_close">&times;</span>
      <iframe id="promptFrame" src="" style="width:90%;height:400px;border:none;"></iframe>
    </div>
  </div>


  <!-- Popup: Wird generiert -->
  <div id="generatingPopup" class="modal_g hidden_g">
    <div class="modal_g-content">
      <p>Generate new content...</p>
    </div>
  </div>


  <!-- Popup: Fertig -->
  <div id="finishedPopup" class="modal hidden">
    <div class="modal-content">
      <p>New content is ready!</p>
      <button id="okBtn">OK</button>
    </div>
  </div>



  <script>
    async function postNow(button) {
      const filename = button.dataset.filename;
      //if (!confirm("Please confirm this post before posting it!")) return; 

      const response = await fetch("/post_now", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });

    }


    async function schedulePost(button) {
      const filename = button.dataset.filename;

      const response = await fetch("/schedule_this", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });
    }  


    async function generateNew(button) {
      const prompt = button.dataset.prompt;

      const response = await fetch("/generate_new", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });
    }   


    async function createCustomContent(button) {
      const filename = button.dataset.filename;

      const response = await fetch("/new_custom", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });
    }  



    document.addEventListener("DOMContentLoaded", function() {
      const modal = document.getElementById("scheduleModal");
      const closeBtn = document.querySelector(".close");
      const frame = document.getElementById("scheduleFrame");

      const pmodal = document.getElementById("promptModal");
      const pcloseBtn = document.querySelector(".p_close");
      const pframe = document.getElementById("promptFrame");

      document.querySelectorAll(".btn-schedule").forEach(btn => {
        btn.addEventListener("click", function() {
          const filename = this.getAttribute("data-filename");
          frame.src = "/scheduler?filename=" + encodeURIComponent(filename);
          modal.style.display = "block";
        });
      });

      document.querySelectorAll(".btn-promptEdit").forEach(btn => {
        btn.addEventListener("click", function() {
          const data = this.getAttribute("data-prompt");
          frame.src = "/edit_prompt?prompt=" + encodeURIComponent(data);
          modal.style.display = "block";
        });
      });

      closeBtn.onclick = function() {
        modal.style.display = "none";
        frame.src = ""; // reset
      }
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
          frame.src = "";
        }
      }
    });


    
    async function reloadCard(filename) {
      const cardEl = document.querySelector(`.linkedin-card[data-filename="${filename}"]`);
      if (!cardEl) return;

      const response = await fetch(`/card/${filename}`);
      if (!response.ok) {
          alert("Fehler beim Laden der Card");
          return;
      }
      const newHtml = await response.text();

      // Neuen HTML-String in DOM umwandeln
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = newHtml.trim();

      const newCard = tempDiv.querySelector(".linkedin-card");
      if (newCard) {
          cardEl.replaceWith(newCard);
      }
    }



 



    async function changeOrigin(button) {
      const filename = button.dataset.filename;
      const isActive = button.classList.contains("active");
      const origin = isActive ? "Personal" : "Company";

      const response = await fetch("/change_origin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, origin })
      });

      if (response.ok) {
        if (origin === "Company") {
          button.classList.add("active");
          button.textContent = "Company";
        } else {
          button.classList.remove("active");
          button.textContent = "Personal";
        }
      } else {
        alert("Fehler beim Aktualisieren");
      }
    }

    async function toggleConfirmed(button) {
      const filename = button.dataset.filename;
      const isActive = button.classList.contains("active");
      const confirmed = isActive ? "No" : "Yes";

      const response = await fetch("/update_flag", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, confirmed })
      });

      if (response.ok) {
        if (confirmed === "Yes") {
          button.classList.add("active");
          button.textContent = "Confirmed";
        } else {
          button.classList.remove("active");
          button.textContent = "☐ Confirm";
        }
      } else {
        alert("Fehler beim Aktualisieren");
      }
    }

    async function archivePost(button) {
      const filename = button.dataset.filename;
      //if (!confirm("really delete this post?")) return;

      const response = await fetch("/archive_post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });

      if (response.ok) {
        button.closest(".card").remove();
      } else {
        alert("Fehler beim Archivieren");
      }
    }

    async function deletePost(button) {
      const filename = button.dataset.filename;
      if (!confirm("really delete this post?")) return;

      const response = await fetch("/delete_post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });

      if (response.ok) {
        button.closest(".card").remove();
      } else {
        alert("Fehler beim Löschen");
      }
    }

    
    document.querySelectorAll(".generateBtn").forEach(btn => {
      btn.addEventListener("click", function() {
        let prompt = this.dataset.prompt;

        // Popup anzeigen
        const generatingPopup = document.getElementById("generatingPopup");
        generatingPopup.classList.remove("hidden_g");

        // Popup nach 3 Sekunden automatisch schließen
        setTimeout(() => {
          generatingPopup.classList.add("hidden_g");
        }, 3000);

        // Anfrage an Flask starten
        fetch("/generate_new_content", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: prompt })
        })
        .then(() => {
          // Polling starten
          let interval = setInterval(() => {
            fetch("/check_status")
              .then(r => r.json())
              .then(data => {
                if (data.finished) {
                  clearInterval(interval);
                  const finishedPopup = document.getElementById("finishedPopup");
                  finishedPopup.classList.remove("hidden_g");

                  document.getElementById("okBtn").onclick = function() {
                    finishedPopup.classList.add("hidden_g");
                    location.reload();
                  };
                }
              });
          }, 5000);
        });
      });
    });

  </script>
</body>
</html>
